<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinyGallery ðŸ“·</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; margin: 0;
            background-image: url('bg.jpeg'); background-size: cover;
            background-position: center; background-attachment: fixed; min-height: 100vh;
        }
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: -1;
        }
        .header { 
            background: rgba(216, 27, 96, 0.4); backdrop-filter: blur(10px);
            color: white; padding: 30px 15px; position: sticky; top: 0; z-index: 1000;
            text-align: center;
        }
        .profile-img {
            width: 80px; height: 80px; border-radius: 50%; border: 3px solid white;
            margin: 0 auto 10px; background-image: url('bgg.jpeg'); background-size: cover;
        }
        .gallery { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; padding: 20px; 
        }
        .card { 
            background: white; border-radius: 15px; overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.3s;
        }
        .card img { width: 100%; height: auto; display: block; }
        .card-info { padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .upload-btn { 
            background: #e91e63; color: white; padding: 10px 25px; 
            border-radius: 50px; cursor: pointer; font-weight: bold; display: inline-block;
        }
        .delete-btn { background: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .reset-link {
            display: block; margin-top: 15px; color: #fff; font-size: 13px;
            text-decoration: underline; cursor: pointer; opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="profile-img"></div>
        <h1>TinyGallery ðŸ“·</h1>
        <p>Private â€¢ Compressed â€¢ Secure</p>
        <label class="upload-btn"> ðŸŒ¸ Upload Memory <input type="file" id="file-input" accept="image/*" style="display:none"></label>
        <span class="reset-link" onclick="resetMyPin()">Forgot or Change PIN?</span>
    </div>
    <div id="gallery" class="gallery"></div>

<script>
    // FIX: Removed citations from inside the code strings
    const CLOUD_NAME = "deu54sydq"; 
    const UPLOAD_PRESET = "simpy_vault"; 
    const gallery = document.getElementById('gallery');

    function resetMyPin() {
        if(confirm("Do you want to reset your PIN? Your old photos will remain safe. ðŸŒ¸")) {
            localStorage.removeItem('myPrivatePin');
            alert("PIN has been reset! Please set a new PIN during your next upload.");
            location.reload(); 
        }
    }

    document.getElementById('file-input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;

        let userPin = localStorage.getItem('myPrivatePin');
        if (!userPin) {
            userPin = prompt("Welcome! Please set your new Secret PIN ðŸŒ¸");
            if (userPin) {
                localStorage.setItem('myPrivatePin', userPin);
                alert("PIN set successfully!");
            } else return;
        }

        const enterPin = prompt("Security Check: Enter your PIN ðŸŒ¸");
        if (enterPin !== userPin) {
            alert("Incorrect PIN! âŒ");
            return;
        }

        alert("Optimizing Image Quality... â³");
        
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = async () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 900; 
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(async (blob) => {
                    const formData = new FormData();
                    formData.append('file', blob);
                    formData.append('upload_preset', UPLOAD_PRESET);

                    try {
                        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                            method: 'POST', body: formData
                        });
                        const data = await res.json();
                        
                        // Log for debugging
                        console.log("Response:", data);

                        if(data.secure_url) {
                            saveToLocal(data.secure_url);
                            displayImage(data.secure_url);
                            alert("Gallery Updated! ðŸŒ¸");
                        } else {
                            alert("Upload failed: " + (data.error ? data.error.message : "Unknown error"));
                        }
                    } catch (err) { 
                        console.error(err);
                        alert("Network Error! Check your internet."); 
                    }
                }, 'image/jpeg', 0.6); 
            };
        };
    });

    function displayImage(url) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<img src="${url}"><div class="card-info"><span>Saved Memory</span><button class="delete-btn" onclick="deletePhoto('${url}', this)">Delete</button></div>`;
        gallery.prepend(card);
    }

    function saveToLocal(url) {
        let photos = JSON.parse(localStorage.getItem('tinyGalleryData') || '[]');
        photos.push(url);
        localStorage.setItem('tinyGalleryData', JSON.stringify(photos));
    }

    function deletePhoto(url, btn) {
        if(confirm("Delete this photo permanently from your gallery?")) {
            let photos = JSON.parse(localStorage.getItem('tinyGalleryData') || '[]');
            photos = photos.filter(p => p !== url);
            localStorage.setItem('tinyGalleryData', JSON.stringify(photos));
            btn.closest('.card').remove();
        }
    }

    const savedPhotos = JSON.parse(localStorage.getItem('tinyGalleryData') || '[]');
    savedPhotos.forEach(displayImage);
</script>
</body>
</html>
